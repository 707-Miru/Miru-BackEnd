<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.back.miru.model.dao.PictureDAO">

    <!-- 사진 등록 -->
    <insert id="registPicture" parameterType="Map">
        INSERT INTO picture (id, followId)
        VALUES (#{id}, #{followId})
    </insert>

    <!-- 전체 사진 불러오기 -->
    <select id="selectAllPictures" parameterType="ListParameterDto" resultType="Map">
        SELECT p.pictureIdx, p.filepath, p.tag,
               IFNULL((SELECT COUNT(*)
                       FROM favoritePicture
                       GROUP BY pictureIdx
                       HAVING pictureIdx = p.pictureIdx), 0) likeCnt,
               IF(p.pictureIdx
                      IN (SELECT pictureIdx
                          FROM favoritePicture
                          WHERE id = #{id}), 1, 0) likeFlag, p.updateTime
        FROM picture p LEFT OUTER JOIN favoritePicture fp
            ON p.pictureIdx = fp.pictureIdx
        WHERE p.publicFlag = 1 OR p.id = #{id}
        GROUP BY p.pictureIdx
        ORDER BY
        <choose>
            <when test="sortKeyword == 'like'">
                likeCnt DESC, p.updateTime DESC, pictureIdx DESC
            </when>
            <otherwise>
                p.updateTime DESC, likeCnt DESC, pictureIdx DESC
            </otherwise>
        </choose>
        LIMIT #{start}, #{currentPerPage}
    </select>

    <!-- 전체 태그 불러오기 -->
    <!-- 수정 필요 -->
    <select id="selectAllPictureTag" parameterType="String" resultType="Map">
        SELECT Tag
        FROM picture
    </select>

    <!-- 좋아요 누른 사진 불러오기 -->
    <!-- 한 사진 좋아요 수는 어떻게 세지? -->
    <select id="selectLickPressPictures" parameterType="String" resultType="Map">
        SELECT p.pictureIdx, p.filepath, p.tag, p.publicFlag, p.isPicture
        FROM picture p
                 JOIN favoritepicture f ON (p.pictureIdx = f.pictureIdx)
        WHERE f.user = #{userId}
    </select>

    <!-- 사진 디테일 -->
    <select id="detailPicture" parameterType="String" resultType="Picture">
        SELECT pictureIdx
        FROM picture
        WHERE id = #{id}
    </select>

    <!-- 좋아요 누른 사진들 불러오기 -->
    <select id="getFavoritePictures" parameterType="String" resultType="List">
        SELECT pictureIdx
        FROM picture
        WHERE publicFlag = 1
    </select>

    <!-- 사진 삭제 -->
    <delete id="deletePicture" parameterType="Map">
        DELETE
        FROM picture
        WHERE id = #{id}
          AND followId = #{followId}
    </delete>

    <!-- 사진 검색하기 -->
    <select id="searchPictureList" parameterType="ListParameterDto" resultType="Map">
        SELECT p.pictureIdx, p.filepath, p.tag,
        IFNULL((SELECT COUNT(*)
        FROM favoritePicture
        GROUP BY pictureIdx
        HAVING pictureIdx = p.pictureIdx), 0) likeCnt,
        IF(p.pictureIdx
        IN (SELECT pictureIdx
        FROM favoritePicture
        WHERE id = #{id}), 1, 0) likeFlag, p.updateTime
        FROM picture p LEFT OUTER JOIN favoritePicture fp
        ON p.pictureIdx = fp.pictureIdx
        WHERE (p.publicFlag = 1 OR p.id = #{id})
        AND p.isPicture = #{isPicture}
        AND p.tag LIKE CONCAT('%', #{keyword}, '%')
        GROUP BY p.pictureIdx
        ORDER BY
        <choose>
            <when test="sortKeyword == 'like'">
                likeCnt DESC, p.updateTime DESC, pictureIdx DESC
            </when>
            <otherwise>
                p.updateTime DESC, likeCnt DESC, pictureIdx DESC
            </otherwise>
        </choose>
        LIMIT #{start}, #{currentPerPage}
    </select>
</mapper>